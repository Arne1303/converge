name: npm-build
on:
  pull_request:
    branches:
      - master
    types:
      - closed
  push:
    branches:
      - master
jobs:
  npm-build:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    permissions:
        contents: write
    steps:
      - name: Manual checkout
        run: |
          git clone https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git .
          git checkout master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Use Node.js
        run: |
          echo "Node.js version:"
          node --version
          echo "npm version:"
          npm --version
      
      - name: Install dependencies
        run: npm ci
        
      - name: Build assets
        run: |
          echo "Building assets..."
          npm run build
          
      - name: Pull changes 
        run: git pull 
          
      - name: List files in the dist directory
        run: |
          echo "Listing files in dist folder"
          ls -R ./dist
          
      - name: Commit changes
        run: |
          git config user.name "$(git log -n 1 --pretty=format:%an)"
          git config user.email "$(git log -n 1 --pretty=format:%ae)"
          git add -f ./dist
          git diff --staged --quiet || git commit -m "chore: build assets"
          git push origin master
